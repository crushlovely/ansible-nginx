---
- name: SSL | Create SSL directory
  file: path=/etc/nginx/ssl/ state=directory owner=root group=root
  sudo: yes

- name: SSL | Apply SSL VHOST file
  template: src=passenger.ssl.site.j2 dest=/etc/nginx/sites-enabled/{{ app_name }} owner=root group=root
  sudo: yes
  when: passenger == "true"

- name: SSL | Copy SSL Cert
  copy: src={{ nginx.ssl_cert.crt }} dest=/etc/nginx/ssl/ owner=root group=root force=yes
  sudo: yes

- name: SSL | Copy SSL Key
  copy: src={{ nginx.ssl_cert.key }} dest=/etc/nginx/ssl/ owner=root group=root force=yes
  sudo: yes

- name: Check if installed
  shell: /usr/bin/test `cat /etc/nginx/nginx.conf 2>&1 | grep "ssl_dhparam" | awk '{gsub("ssl_dhparam/","",$1); print $1}'` = ssl_dhparam && echo True
  register: dhparam_cert
  ignore_errors: yes

- name: SSL | Create DHPARAM cert
  command: openssl dhparam -outform pem -out /etc/nginx/ssl/dhparam2048.pem 2048
  sudo: yes
  when: dhparam_cert|failed